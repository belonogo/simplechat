#include <QSpinBox>
#include <QLineEdit>
#include <QValidator>
#include <QRegExpValidator>
#include <QString>

class HexSpinBox : public QSpinBox {
    Q_OBJECT

public:
    explicit HexSpinBox(QWidget* parent = nullptr)
        : QSpinBox(parent) {
        setDisplayIntegerBase(16); // Устанавливаем HEX формат
        setRange(0, 0xFF);        // Устанавливаем начальное значение
        setValue(0);              // Начальное значение

        // Устанавливаем валидатор на lineEdit
        updateMaxDigits();
        updateValidator();
    }

    // Устанавливаем максимальное значение
    void setMaxValue(int maxValue) {
        setMaximum(maxValue);
        updateMaxDigits();
        updateValidator();
    }

protected:
    // Форматируем вывод с ведущими нулями
    QString textFromValue(int value) const override {
        return QString("%1").arg(value, maxDigits, 16, QLatin1Char('0')).toUpper();
    }

    // Конвертация текста в значение
    int valueFromText(const QString& text) const override {
        bool ok;
        return text.toInt(&ok, 16);
    }

    // Обрабатываем шаг как изменение на 1 бит
    void stepBy(int steps) override {
        setValue(value() + steps);
    }

private:
    int maxDigits; // Количество цифр в отображении

    // Обновляем количество отображаемых цифр
    void updateMaxDigits() {
        maxDigits = QString::number(maximum(), 16).length();
    }

    // Обновляем валидатор для ограничения количества символов
    void updateValidator() {
        QString pattern = QString("^[0-9a-fA-F]{1,%1}$").arg(maxDigits);
        QRegExp hexRegex(pattern);
        QValidator* validator = new QRegExpValidator(hexRegex, this);

        if (QLineEdit* edit = lineEdit()) {
            edit->setValidator(validator);
        }
    }
};
